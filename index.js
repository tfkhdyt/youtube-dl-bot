const youtubedl=require("youtube-dl-exec"),{Telegraf:Telegraf,Markup:Markup}=require("telegraf"),{Composer:Composer}=require("micro-bot"),{Keyboard:Keyboard,Key:Key}=require("telegram-keyboard"),fs=require("fs"),path=require("path"),glob=require("glob");require("dotenv").config();const NODE_ENV=process.env.NODE_ENV,BOT_TOKEN=process.env.BOT_TOKEN;let url;switch(NODE_ENV){case"development":bot=new Telegraf(BOT_TOKEN);break;case"production":bot=new Composer}const monthNumberToString=e=>{switch(e){case"01":return"Januari";case"02":return"Februari";case"03":return"Maret";case"04":return"April";case"05":return"Mei";case"06":return"Juni";case"07":return"Juli";case"08":return"Agustus";case"09":return"September";case"10":return"Oktober";case"11":return"November";case"12":return"Desember"}},dateFormatter=e=>{const t=e.substring(6,8),a=e.substring(4,6),r=e.substring(0,4);return`${t} ${monthNumberToString(a)} ${r}`},secondsToTimestamp=e=>new Date(1e3*e).toISOString().substr(11,8),formatNumber=e=>e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1."),convertToICS=e=>Math.abs(Number(e))>=1e9?(Math.abs(Number(e))/1e9).toFixed(1)+" miliar":Math.abs(Number(e))>=1e6?(Math.abs(Number(e))/1e6).toFixed(1)+" juta":Math.abs(Number(e))>=1e3?(Math.abs(Number(e))/1e3).toFixed(1)+" ribu":Math.abs(Number(e)),getMetadata=(e,t)=>youtubedl(e,{dumpSingleJson:!0,noWarnings:!0,noCallHome:!0,noCheckCertificate:!0,preferFreeFormats:!0,youtubeSkipDashManifest:!0}).then((e=>e)).catch((e=>t.reply("Video tidak ditemukan, pastikan link video tersebut sudah benar! ðŸ™ðŸ¼"))),formatBytes=(e,t=2)=>{if(0===e)return"0 Bytes";const a=t<0?0:t,r=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,r)).toFixed(a))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][r]};let audioFileSize;const getFormats=e=>{const t=e.find((e=>"140"==e.format_id));return audioFileSize=t.filesize,e.filter((e=>null!=e.fps&&"none"==e.acodec))},showQuality=e=>{const t=e.map((e=>{const t=e.format_id,a=e.format_note,r=(e.fps,e.vcodec.substring(0,4).toUpperCase()),n=formatBytes(e.filesize+audioFileSize);return Key.callback(`${a} | ${r} | ${n}`,t)}));return Keyboard.make(t,{columns:2}).inline()},validation=e=>e.includes("youtu")&&e.includes("be");let display_id;switch(bot.start((e=>e.replyWithMarkdown(`Halo ${e.from.first_name}, selamat datang di YT-DL Bot, kirim link video yang ingin anda unduh untuk mengunduh video tersebut.\n\n*PERHATIAN*: Dikarenakan storage hosting yang terbatas, maka kalian tidak dapat mengunduh video yang memiliki ukuran di atas *500 MB*`))),bot.command("help",(e=>e.reply("Anda hanya perlu mengirimkan link dari video yang ingin diunduh"))),bot.on("text",(async e=>{if(url=e.message.text,!validation(url))return e.reply("Harap masukkan link yang valid! ðŸ™ðŸ¼");const t=await getMetadata(url,e),a=getFormats(t.formats);display_id=t.display_id;const r=t.title,n=dateFormatter(t.upload_date),o=t.channel,i=(s=t.duration,new Date(1e3*s).toISOString().substr(11,8));var s;const u=convertToICS(t.view_count),l=convertToICS(t.like_count),d=convertToICS(t.dislike_count),c=(t.like_count/(t.like_count+t.dislike_count)*100).toFixed(1)+"%",m=(t.dislike_count/(t.like_count+t.dislike_count)*100).toFixed(1)+"%",b=e.update.message.message_id,g=`ðŸ“„ *Judul*: \`${r}\`\nðŸ‘¨ðŸ» *Channel*: \`${o}\`\nðŸ“† *Tanggal di-upload*: \`${n}\`\nðŸ•– *Durasi*: \`${i}\`\nðŸ‘€ *Jumlah penonton*: \`${u}\`\nðŸ‘ðŸ¼ *Jumlah like*: \`${l} (${c})\`\nðŸ‘ŽðŸ¼ *Jumlah dislike*: \`${d} (${m})\``;e.replyWithMarkdown(g,{reply_to_message_id:b}),e.reply("ðŸŽ¥ Pilih kualitas: ",showQuality(a))})),bot.on("callback_query",(e=>{e.deleteMessage(e.update.callback_query.message.message_id);const t=e.callbackQuery.data;let a;console.log("Downloading..."),e.replyWithMarkdown("_Sedang mengunduh..._").then((e=>{a=e.message_id})),youtubedl(url,{format:`${t}+140`,output:`%(id)s-${t}`,noWarnings:!0,noCallHome:!0,noCheckCertificate:!0,preferFreeFormats:!0,youtubeSkipDashManifest:!0}).then((r=>{e.deleteMessage(a),console.log("Uploading..."),e.replyWithMarkdown("_Sedang mengunggah..._").then((e=>{a=e.message_id}));const n=path.extname(glob.sync(`${display_id}-${t}.*`)[0]).substring(1);e.replyWithVideo({source:`${display_id}-${t}.${n}`},{...Markup.inlineKeyboard([[Markup.button.url("ðŸ’µ Donasi","https://donate.tfkhdyt.my.id/"),Markup.button.url("ðŸ’» Source Code","https://github.com/tfkhdyt/youtube-dl-bot/")],[Markup.button.url("ðŸ’  Project saya yang lainnya","https://tfkhdyt.my.id/#portfolio")]])}).then((()=>{e.deleteMessage(a);const r=`./${display_id}-${t}.${n}`;fs.unlink(r,(e=>{if(e)throw e;console.log("File removed:",r)})),youtubedl(url,{rmCacheDir:!0,simulate:!0,noWarnings:!0,noCallHome:!0,noCheckCertificate:!0,preferFreeFormats:!0,youtubeSkipDashManifest:!0}).then((e=>console.log(e)))}))}))})),NODE_ENV){case"development":bot.launch();break;case"production":module.exports=bot}
